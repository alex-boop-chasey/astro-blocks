---
/**
 * ============================================================================
 * IMAGE - Optimized Image Component
 * ============================================================================
 *
 * Advanced image component with automatic optimization for both local and
 * external images. Handles responsive images, lazy loading, and format conversion.
 *
 * FEATURES:
 * - Automatic optimization for local Astro assets
 * - External CDN image optimization via Unpic (Pixabay, Unsplash, etc.)
 * - Responsive srcset generation with multiple breakpoints
 * - Layout modes: fixed, constrained, fullWidth, cover, responsive, contained
 * - Lazy loading by default (configurable)
 * - AVIF/WebP format conversion when appropriate
 * - Automatic aspect ratio preservation
 * - Crossorigin and referrer policy handling
 *
 * USAGE:
 * <Image
 *   src="https://example.com/image.jpg"
 *   alt="Description"
 *   width={800}
 *   height={600}
 *   widths={[400, 800, 1200]}
 *   sizes="(max-width: 768px) 100vw, 800px"
 *   layout="responsive"
 *   loading="lazy"
 * />
 *
 * PROPS:
 * - src: string | ImageMetadata (required) - Image source
 * - alt: string (required) - Alt text for accessibility
 * - width: number - Image width
 * - height: number - Image height
 * - widths: number[] - Responsive breakpoint widths for srcset
 * - sizes: string - Sizes attribute for responsive images
 * - layout: Layout - Image layout mode
 * - loading: 'lazy' | 'eager' - Loading strategy (default: lazy)
 * - aspectRatio: string | number - Aspect ratio (e.g., "16:9" or 1.777)
 *
 * NOTE: This component is based on the AstroWind template's Image component.
 * ============================================================================
 */
import type { HTMLAttributes } from 'astro/types';
import { findImage } from '~/utils/images';
import {
  getImagesOptimized,
  astroAssetsOptimizer,
  unpicOptimizer,
  isUnpicCompatible,
  type ImageProps,
  type ImagesOptimizer,
} from '~/utils/images-optimization';

type Props = ImageProps;
type ImageType = {
  src: string;
  attributes: HTMLAttributes<'img'>;
};

const props = Astro.props;
const noopOptimizer: ImagesOptimizer = async () => [];

if (props.alt === undefined || props.alt === null) {
  throw new Error();
}

if (typeof props.width === 'string') {
  props.width = parseInt(props.width);
}

if (typeof props.height === 'string') {
  props.height = parseInt(props.height);
}

if (!props.loading) {
  props.loading = 'lazy';
}

if (!props.decoding) {
  props.decoding = 'async';
}

const _image = await findImage(props.src);

let image: ImageType | undefined = undefined;
let avif: ImageType | undefined = undefined;
let webp: ImageType | undefined = undefined;

const isExternal = typeof _image === 'string' && (_image.startsWith('http://') || _image.startsWith('https://'));
const canUseUnpic = isExternal && isUnpicCompatible(_image as string);

if (canUseUnpic) {
  // External CDN image that Unpic can optimize
  image = await getImagesOptimized(_image as string, props, unpicOptimizer);
  if (!props.format) {
    avif = await getImagesOptimized(_image as string, { ...props, format: 'avif' }, unpicOptimizer);
    webp = await getImagesOptimized(_image as string, { ...props, format: 'webp' }, unpicOptimizer);
  }
} else if (_image && !isExternal) {
  // Local Astro asset
  image = await getImagesOptimized(_image, props, astroAssetsOptimizer);
  if (!props.format) {
    avif = await getImagesOptimized(_image, { ...props, format: 'avif' }, astroAssetsOptimizer);
    webp = await getImagesOptimized(_image, { ...props, format: 'webp' }, astroAssetsOptimizer);
  }
} else if (isExternal) {
  // External URL without optimization support - use original source
  image = await getImagesOptimized(_image as string, props, noopOptimizer);
}
---

{
  !image ? (
    <Fragment />
  ) : (
    <>
      {avif?.attributes?.srcset || webp?.attributes?.srcset ? (
        <picture>
          {avif?.attributes?.srcset ? (
            <source type="image/avif" srcset={avif.attributes.srcset} sizes={avif.attributes.sizes} />
          ) : null}
          {webp?.attributes?.srcset ? (
            <source type="image/webp" srcset={webp.attributes.srcset} sizes={webp.attributes.sizes} />
          ) : null}
          <img src={image.src} crossorigin="anonymous" referrerpolicy="no-referrer" {...image.attributes} />
        </picture>
      ) : (
        <img src={image.src} crossorigin="anonymous" referrerpolicy="no-referrer" {...image.attributes} />
      )}
    </>
  )
}
